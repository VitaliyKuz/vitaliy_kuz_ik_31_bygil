## Lab_3: Вступ до моніторингу.

### Pre-requirements:

- середовище з інстальованим Python / pip / pipenv;
- будь-який WEB-браузер;

### What to do.

1. Створир папку з назвою лабораторної роботи у власному репозиторію. Перейшов у папку ініціалізував середовище `pipenv`
   та встановив необхідні пакети:
    ```bash
    pipenv --python 3.7
    pipenv install django
    ```
2. За допомогою Django Framework створив заготовку (template)  проекту pipenv run django-admin startproject my_site

   mv my_site/my_site/* kuz_site/ mv my_site/manage.py ./
    ```
    ```text
    lab3/
    ├── kuz_site/
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    └── manage.py
    ```
3. Все встановилось правильно і запустив Django сервер. Командою вказану нижче та перейшов за посиланням яке вивелось у
   консолі
    ```bash
    pipenv run python manage.py runserver
    ```
4. Все запустилось успішно і стартова сторінка Django відображається коректно, зупинив сервер виконавши
   переривання `Ctrl+C`. Створив коміт із базовим темплейтом сайту.
5. Створив темплейт додатку у якому описано всі web сторінки сайту . Створив коміт із новоствореними файлами темплейту
   додатка:
    ```bash
    pipenv run python manage.py startapp main
    ```
6. Створив папку `main/templates/`, а також у даній папці файл з розширенням `.html` (`main.html`). Також у папці
   додатку створив ще один файл `main/urls.py`. Зробив коміт із даними файлами;
7. Після створення додатку вказав Django frameworks його назву та де шукати веб сторінки. Це здійснюється у
   файлі `kuz_site/settings.py`у змінній `INSTALLED_APPS`, а також внесіть зміни у файл `my_site/url.py` (дивіться мої
   файли як зразок);
8. Далі перейшов до нашого додатку та зайнявся сторінками
    - створив сторінки двох типів - перша буде зчитуватись з `.html` темплейта. друга сторінка буде просто повертати
      відповідь у форматі JSON;
    - відкрив та ознайомився із вмістом файла `kuz_main/views.py`.

9. Поєднати функції із реальними URL шляхами за якими будуть доступні веб сторінки заповнив файл `kuz_main/urls.py`
   згідно мого зразка. Як можна зрозуміти з коду у нас є два URL посидання:
    - головна сторінка яка буде опрацьовуватись функцією `kuz_main`;
    - сторінка health/ яка буде опрацьована функцією `health`;
10. Запустив сервер та переконався що сторінки доступні. Виконав коміт робочого Django сайту.
    1. Роль моніторингу буде здійснювати файл `monitoring.py` який за допомогою бібліотеки `requests` буде опитувати
       сторінку `health`. Встановив дану бібліотеку;
        ```bash
        pipenv install requests
        ```
11. Із заготовленої функції health() відповідь формується як Пайтон словник і далі обробляється функцією JsonResponse().
    Для здачі/захисту лабораторної потрібно зробити:
    1. модифікувати функцію `health` так щоб у відповіді були: згенерована на сервері дата, URL сторінки моніторингу,
    інформація про сервер на якому запущений сайт та інформація про клієнта який робить запит до сервера;
    ```bash 
    def health(request):
    response = {'date': datetime.now(), 'current_page': request.get_host() + request.get_full_path(), 'server_info': os.uname(),
    'client_info': request.headers['User-Agent']} return JsonResponse(response)
    ```
    2. дописав функціонал який буде виводити повідомлення про недоступність сайту у випадку якщо WEB сторінка
    недоступна (як можна побачити функція requests.get() буде видавати помилку при недоступності сторінки);
    ```bash    
    def main(url):
    try:
    r = requests.get(url)
    except requests.exceptions.ConnectionError:
    logging.error("Please run server")
    else:
    data = json.loads(r.content)
    logging.info("Сервер доступний. Час на сервері: %s", data['date'])
    logging.info("Запитувана сторінка: : %s", data['current_page'])
    logging.info("Відповідь сервера містить наступні поля:")
    for key in data.keys():
    logging.info("Ключ: %s, Значення: %s", key, data[key])
    ```

    3. Після запуску моніторингу запит йде лише один раз після чого програма закінчується - зробив так щоб дана програма
    запускалась раз в хвилину та працювала в бекграунді
    ```bash
        if __name__ == '__main__':
    while True:
        main("http://localhost:8000/health")
        time.sleep(60)
    ```
     4. Спростив роботу з пайтон середовищем через швидкий виклик довгих команд, для цього зверніть увагу на
    секцію `scripts` у Pipfile. Я додав аліас на запуск сервера який тепер буде стартувати за командою представленою
    нижче. Зробив аліас на запус моніторингу:

    ```bash
    [scripts]
    server = "python manage.py runserver 127.0.0.1:8000"
    monitoring = "python3 monitoring.py"
    ```
12. Запустив сервер та переконався що головна сторінка відображається. Перейдов у інше вікно консолі та запустіть
    програму моніторингу. Закомітив файл логів `server.logs` до репозиторію.
13. Після успішного виконання роботи відредагуйте Ваш персональний _README.md_ у цьому репозиторію. Створіть таблицю яка
    ставить у відповідність номер лабораторної роботи та URL посилання на папку з виконаною роботою у Вашому
    персональному репозиторію. Створіть пул-реквест до основного репозиторію.
